
```{r}
library(ggplot2)
library(plyr)
library(dplyr)
library(tidyr)
library(psych)
library(ggstats)
library(ppcor)
```

# Freesurfer Precuneus (only for visualization)
```{r}
file_path <- "E:/liz/Defense/Neuroimaging/fs_CT_All_winsorized_plot.csv"
df <- read.csv(file_path) |> na.omit()

xvar <- "lh.precuneus"     
yvar <- "winsorized_MRT"   
gvar <- "Sex"             

col_F <- "#56B1F7"
col_M <- "#244C70"

spearman_stats <- function(dat, x, y) {
  keep <- complete.cases(dat[[x]], dat[[y]])
  ct   <- suppressWarnings(cor.test(dat[[x]][keep], dat[[y]][keep], method = "spearman"))
  tibble(rho = unname(ct$estimate), p = ct$p.value, n = sum(keep))
}
fmt_p <- function(p) ifelse(p < .001, format(p, digits = 2, scientific = TRUE), sprintf("%.3f", p))

# Overall + by-sex stats
overall <- spearman_stats(df, xvar, yvar) |> mutate(who = "Overall")
stats_F <- spearman_stats(filter(df, .data[[gvar]] == "F"), xvar, yvar) |> mutate(who = "F")
stats_M <- spearman_stats(filter(df, .data[[gvar]] == "M"), xvar, yvar) |> mutate(who = "M")

fmt_p_plain <- function(p) ifelse(p < .001, "< .001", sprintf("%.3f", p))

# Labels
lab_overall <- overall |>
  mutate(label = sprintf("𝜌 = %.2f\n𝑝 = %s\nn = %d", rho, fmt_p_plain(p), n))
lab_F <- stats_F |>
  mutate(label = sprintf("𝜌 = %.2f\n𝑝 = %s\nn = %d", rho, fmt_p_plain(p), n))
lab_M <- stats_M |>
  mutate(label = sprintf("𝜌 = %.2f\n𝑝 = %s\nn = %d", rho, fmt_p_plain(p), n))

# ---- Layout / label placement ----
xr <- range(df[[xvar]], na.rm = TRUE)
yr <- range(df[[yvar]], na.rm = TRUE)

# extend x-axis to the right to make room for labels (10% extra)
extra_x   <- 0.23 * diff(xr)
xlim_ext  <- c(xr[1], xr[2] + extra_x)

# put labels in the added right margin (a bit inside)
x_pos <- xr[2] + 0.02 * diff(xr)
y_top <- yr[2] - 0.05 * diff(yr)

# label positions with fixed vertical offset (independent of y axis range)
offset <- 0.95   # change to move closer/further apart

lab_overall$x <- x_pos; lab_overall$y <- y_top
lab_F$x       <- x_pos; lab_F$y       <- y_top - offset
lab_M$x       <- x_pos; lab_M$y       <- y_top - 2 * offset
# ---- Plot ----
p <- ggplot(df, aes(x = .data[[xvar]], y = .data[[yvar]], color = .data[[gvar]])) +
  geom_point(alpha = 0.85, size = 2.4) +
  # per-sex linear fits with matching CI fills (lighter alpha to avoid dark saves)
  geom_smooth(aes(fill = .data[[gvar]]), method = "lm", se = TRUE,
              linewidth = 1, alpha = 0.15) +
  # pooled (overall) dashed fit in grey
  geom_smooth(aes(group = 1), method = "lm", se = FALSE,
              color = "grey50", fill = "grey60",
              linetype = "22", linewidth = 1, alpha = 0.15) +
  # Text labels in the right margin; use geom_label for readability
  geom_label(data = lab_overall, aes(x = x, y = y, label = label),
             inherit.aes = FALSE, color = "grey50", fill = "white",
             alpha = 0.8, hjust = 0, label.size = 0.2, lineheight = 1.05,
           size = 4.5) +
  geom_label(data = lab_F, aes(x = x, y = y, label = label),
             inherit.aes = FALSE, color = col_F, fill = "white",
             alpha = 0.8, hjust = 0, label.size = 0.2, lineheight = 1.05,
           size = 4.5) +
  geom_label(data = lab_M, aes(x = x, y = y, label = label),
             inherit.aes = FALSE, color = col_M, fill = "white",
             alpha = 0.8, hjust = 0, label.size = 0.2, lineheight = 1.05,
             size = 4.5) +
  scale_color_manual(values = c(F = col_F, M = col_M), name = "Biological Sex") +
  scale_fill_manual(values = c(F = col_F, M = col_M),  name = "Biological Sex") +
  scale_x_continuous(
  limits = xlim_ext,
  breaks = seq(xr[1], xr[2], length.out = 4),
  labels = function(x) sprintf("%.2f", x)
) +
  labs(
    title = "Left Precuneus",
    x = "Thickness (mm)",
    y = "MRT (Composite Z Score)"
  ) +
  theme_minimal(base_size = 12) +
  theme(
    plot.title = element_text(size = 18, face = "bold", hjust = 0.5),
    aspect.ratio = 1,  # square panel, free data scales
    panel.border = element_rect(color = "grey50", fill = NA, linewidth = .8),
    legend.position = "bottom", panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    axis.title = element_text(size = 16),  # axis labels
    axis.text  = element_text(size = 14)   # axis numbers
  )

print(p)

# ---- Save (white background avoids 'all black' look in some viewers) ----
ggsave("E:/liz/Defense/Neuroimaging/ct_mrt_by_sex_square.png",
       plot = p, width = 6, height = 6, dpi = 300, bg = "white")

```

# ANTs output - All Regions (do partial correlations between CT and behavior and correct for multiple comparisons)
```{r}
df_all   <- read.csv("E:/liz/Defense/Neuroimaging/ants_ct_40_winsorized.csv")          # regions + tasks (same subjects/order)
df_tasks <- read.csv("E:/liz/Defense/Neuroimaging/ants_ct_40_winsorized_tasks.csv")     # tasks only     (same subjects/order)
df_cov   <- read.csv("E:/liz/Defense/Neuroimaging/ants_ct_40_winsorized_cov.csv")       # Age, Sex, Volume (ICV)

# --- Remove ID column if it exists ---
df_all   <- df_all[,  !(names(df_all)   %in% "ID")]
df_tasks <- df_tasks[,!(names(df_tasks) %in% "ID")]
df_cov   <- df_cov[,  !(names(df_cov)   %in% "ID")]

# Recode Sex
df_cov$Sex <- ifelse(df_cov$Sex == "M", 1, 0)

# --- Define groups (use exact column names) ---
region_cols <- c("RH_Cont_Temp_mean","LH_DorsAttn_PrCv_mean","LH_SalVentAttn_FrOperIns_mean",
  "LH_Limbic_TempPole_mean","RH_Vis_mean","RH_SalVentAttn_FrOperIns_mean",
  "LH_Default_pCunPCC_mean","LH_Default_Par_mean","RH_SalVentAttn_Med_mean",
  "RH_Default_Par_mean","LH_DorsAttn_FEF_mean","RH_Limbic_TempPole_mean",
  "LH_Limbic_OFC_mean","RH_Cont_Cing_mean","LH_SalVentAttn_ParOper_mean",
  "RH_DorsAttn_Post_mean","LH_SomMot_mean","RH_DorsAttn_FEF_mean",
  "RH_Default_pCunPCC_mean","RH_SomMot_mean","LH_DorsAttn_Post_mean",
  "LH_Cont_Par_mean","LH_Cont_Cing_mean","LH_Vis_mean",
  "RH_SalVentAttn_TempOccPar_mean","RH_Default_Temp_mean","RH_Default_PFCv_mean",
  "LH_Default_Temp_mean","RH_Limbic_OFC_mean","RH_Cont_PFCl_mean",
  "LH_Default_PFC_mean","RH_Default_PFCdPFCm_mean","LH_Cont_pCun_mean",
  "LH_SalVentAttn_Med_mean","RH_Cont_Par_mean","RH_Cont_PFCmp_mean",
  "LH_Cont_PFCl_mean","RH_Cont_pCun_mean","LH_Cont_Temp","LH_Cont_PFCmp",
  "LH_SalVentAttn_PFCl","RH_SalVentAttn_PFCl","LH_Cont_OFC", "LH_Cont_PFCv_1", "LH_SalVentAttn_TempOcc_1",
  "RH_DorsAttn_PrCv_1", "RH_SalVentAttn_PrC_1")

task_cols   <- c("winsorized_MRT","winsorized_PFT","winsorized_SOT",
                 "winsorized_iVTT","winsorized_RMT")

cov_cols    <- c("Age","Sex","Volume")

# Quick checks
stopifnot(all(region_cols %in% names(df_all)))
stopifnot(all(task_cols   %in% names(df_tasks)))
stopifnot(all(cov_cols    %in% names(df_cov)))

# ===== FIXED-N LISTWISE DELETION ACROSS ALL VARS =====
mask <- complete.cases(
  df_all[,   region_cols, drop = FALSE],
  df_tasks[, task_cols,   drop = FALSE],
  df_cov[,   cov_cols,    drop = FALSE]
)

df_all   <- df_all[mask, ]
df_tasks <- df_tasks[mask, ]
df_cov   <- df_cov[mask, ]
N_global <- nrow(df_cov)   # same for all tests

# --- Containers for results ---
labs <- c(); pvec <- c(); rho <- c(); Ns <- c()

# --- TASK–TASK (unique pairs, fixed N) ---
for (i in 1:(length(task_cols)-1)) {
  for (j in (i+1):length(task_cols)) {
    x <- df_tasks[[task_cols[i]]]
    y <- df_tasks[[task_cols[j]]]
    Z <- df_cov[, cov_cols, drop = FALSE]

    res <- pcor.test(x, y, Z, method = "spearman")
    labs <- c(labs, paste0(task_cols[i], " vs ", task_cols[j]))
    pvec <- c(pvec, res$p.value)
    rho  <- c(rho,  res$estimate)
    Ns   <- c(Ns,   N_global)
  }
}

# --- TASK–REGION (all pairs, fixed N) ---
for (t in task_cols) {
  for (r in region_cols) {
    x <- df_tasks[[t]]
    y <- df_all[[r]]
    Z <- df_cov[, cov_cols, drop = FALSE]

    res <- pcor.test(x, y, Z, method = "spearman")
    labs <- c(labs, paste0(t, " vs ", r))
    pvec <- c(pvec, res$p.value)
    rho  <- c(rho,  res$estimate)
    Ns   <- c(Ns,   N_global)
  }
}

# --- Multiple-comparisons correction (one family across all tests) ---
fdr_p <- p.adjust(pvec, method = "BH")

results <- data.frame(
  Comparison = labs,
  Rho        = rho,
  N          = Ns,
  Raw_p      = pvec,
  FDR_p      = fdr_p,
  stringsAsFactors = FALSE
)

write.csv(results, "E:/liz/Defense/Neuroimaging/ants/BH_results.csv", row.names = FALSE)
```


# ANTs output - Regions of interest - Males (do partial correlations between CT and behavior and correct for multiple comparisons)
```{r}
df_all   <- read.csv("E:/liz/Defense/Neuroimaging/ants_roi.csv")          # regions + tasks (same subjects/order)
df_tasks <- read.csv("E:/liz/Defense/Neuroimaging/ants_ct_40_winsorized_tasks.csv")     # tasks only     (same subjects/order)
df_cov   <- read.csv("E:/liz/Defense/Neuroimaging/ants_ct_40_winsorized_cov.csv")       # Age, Sex, Volume (ICV)

# --- Remove ID column if it exists ---
df_all   <- df_all[,  !(names(df_all)   %in% "ID")]
df_tasks <- df_tasks[,!(names(df_tasks) %in% "ID")]
df_cov   <- df_cov[,  !(names(df_cov)   %in% "ID")]

# Recode Sex
df_cov$Sex <- ifelse(df_cov$Sex == "M", 1, 0)

# --- Define groups ---
region_cols <- c(
  "RH_Cont_Temp_mean",
  "LH_Cont_Temp",
  "LH_Default_pCunPCC_mean",
  "RH_Default_pCunPCC_mean",
  "LH_Cont_pCun_mean",
  "RH_Cont_pCun_mean",
  "LH_DorsAttn_PrCv_mean",
  "RH_DorsAttn_PrCv_1",
  "LH_Default_Par_mean",
  "RH_Default_Par_mean",
  "LH_Cont_Par_mean",
  "RH_Cont_Par_mean",
  "RH_DorsAttn_Post_mean",
  "RH_SalVentAttn_TempOccPar_mean",
  "LH_SalVentAttn_TempOcc_1",
  "LH_DorsAttn_Post_mean"
)

task_cols <- c("winsorized_MRT","winsorized_PFT","winsorized_SOT",
               "winsorized_iVTT","winsorized_RMT")

cov_cols <- c("Age","Volume")   # drop Sex here (since you split by it)

# --- Split dataframes ---
df_all_m   <- df_all[df_cov$Sex == 1, ]
df_tasks_m <- df_tasks[df_cov$Sex == 1, ]
df_cov_m   <- df_cov[df_cov$Sex == 1, ]

mask_m <- complete.cases(df_all_m[,region_cols], df_tasks_m[,task_cols], df_cov_m[,cov_cols])
df_all_m   <- df_all_m[mask_m, ]
df_tasks_m <- df_tasks_m[mask_m, ]
df_cov_m   <- df_cov_m[mask_m, ]
N_global_m <- nrow(df_cov_m)

# --- Containers for results ---
labs <- c(); pvec <- c(); rho <- c(); Ns <- c()

# --- TASK–TASK (unique pairs, fixed N) ---
for (i in 1:(length(task_cols)-1)) {
  for (j in (i+1):length(task_cols)) {
    x <- df_tasks_m[[task_cols[i]]]
    y <- df_tasks_m[[task_cols[j]]]
    Z <- df_cov_m[, cov_cols, drop = FALSE]

    res <- pcor.test(x, y, Z, method = "spearman")
    labs <- c(labs, paste0(task_cols[i], " vs ", task_cols[j]))
    pvec <- c(pvec, res$p.value)
    rho  <- c(rho,  res$estimate)
    Ns   <- c(Ns,   N_global_m)
  }
}

# --- TASK–REGION (all pairs, fixed N) ---
for (t in task_cols) {
  for (r in region_cols) {
    x <- df_tasks_m[[t]]
    y <- df_all_m[[r]]
    Z <- df_cov_m[, cov_cols, drop = FALSE]

    res <- pcor.test(x, y, Z, method = "spearman")
    labs <- c(labs, paste0(t, " vs ", r))
    pvec <- c(pvec, res$p.value)
    rho  <- c(rho,  res$estimate)
    Ns   <- c(Ns,   N_global_m)
  }
}

# --- Multiple-comparisons correction (one family across all tests) ---
fdr_p <- p.adjust(pvec, method = "BH")

results <- data.frame(
  Comparison = labs,
  Rho        = rho,
  N          = Ns,
  Raw_p      = pvec,
  FDR_p      = fdr_p,
  stringsAsFactors = FALSE
)

write.csv(results, "E:/liz/Defense/Neuroimaging/ants/ROI_Males_BH_results.csv", row.names = FALSE)
```


# ANTs output - Regions of interest - Females (do partial correlations between CT and behavior and correct for multiple comparisons)
```{r}
df_all   <- read.csv("E:/liz/Defense/Neuroimaging/ants_roi.csv")          # regions + tasks (same subjects/order)
df_tasks <- read.csv("E:/liz/Defense/Neuroimaging/ants_ct_40_winsorized_tasks.csv")     # tasks only     (same subjects/order)
df_cov   <- read.csv("E:/liz/Defense/Neuroimaging/ants_ct_40_winsorized_cov.csv")       # Age, Sex, Volume (ICV)

# --- Remove ID column if it exists ---
df_all   <- df_all[,  !(names(df_all)   %in% "ID")]
df_tasks <- df_tasks[,!(names(df_tasks) %in% "ID")]
df_cov   <- df_cov[,  !(names(df_cov)   %in% "ID")]

# Recode Sex
df_cov$Sex <- ifelse(df_cov$Sex == "M", 1, 0)

# --- Define groups ---
region_cols <- c(
  "RH_Cont_Temp_mean",
  "LH_Cont_Temp",
  "LH_Default_pCunPCC_mean",
  "RH_Default_pCunPCC_mean",
  "LH_Cont_pCun_mean",
  "RH_Cont_pCun_mean",
  "LH_DorsAttn_PrCv_mean",
  "RH_DorsAttn_PrCv_1",
  "LH_Default_Par_mean",
  "RH_Default_Par_mean",
  "LH_Cont_Par_mean",
  "RH_Cont_Par_mean",
  "RH_DorsAttn_Post_mean",
  "RH_SalVentAttn_TempOccPar_mean",
  "LH_SalVentAttn_TempOcc_1",
  "LH_DorsAttn_Post_mean"
)


task_cols <- c("winsorized_MRT","winsorized_PFT","winsorized_SOT",
               "winsorized_iVTT","winsorized_RMT")

cov_cols <- c("Age","Volume")   # drop Sex here (since you split by it)

# --- Split dataframes ---
df_all_f   <- df_all[df_cov$Sex == 0, ]
df_tasks_f <- df_tasks[df_cov$Sex == 0, ]
df_cov_f   <- df_cov[df_cov$Sex == 0, ]

# Example for females:
mask_f <- complete.cases(df_all_f[,region_cols], df_tasks_f[,task_cols], df_cov_f[,cov_cols])
df_all_f   <- df_all_f[mask_f, ]
df_tasks_f <- df_tasks_f[mask_f, ]
df_cov_f   <- df_cov_f[mask_f, ]
N_global_f <- nrow(df_cov_f)

# (… run loops again …)
# Save to "ROI_BH_results_Male.csv"
# --- Containers for results ---
labs <- c(); pvec <- c(); rho <- c(); Ns <- c()

# --- TASK–TASK (unique pairs, fixed N) ---
for (i in 1:(length(task_cols)-1)) {
  for (j in (i+1):length(task_cols)) {
    x <- df_tasks_f[[task_cols[i]]]
    y <- df_tasks_f[[task_cols[j]]]
    Z <- df_cov_f[, cov_cols, drop = FALSE]

    res <- pcor.test(x, y, Z, method = "spearman")
    labs <- c(labs, paste0(task_cols[i], " vs ", task_cols[j]))
    pvec <- c(pvec, res$p.value)
    rho  <- c(rho,  res$estimate)
    Ns   <- c(Ns,   N_global_f)
  }
}

# --- TASK–REGION (all pairs, fixed N) ---
for (t in task_cols) {
  for (r in region_cols) {
    x <- df_tasks_f[[t]]
    y <- df_all_f[[r]]
    Z <- df_cov_f[, cov_cols, drop = FALSE]

    res <- pcor.test(x, y, Z, method = "spearman")
    labs <- c(labs, paste0(t, " vs ", r))
    pvec <- c(pvec, res$p.value)
    rho  <- c(rho,  res$estimate)
    Ns   <- c(Ns,   N_global_f)
  }
}

# --- Multiple-comparisons correction (one family across all tests) ---
fdr_p <- p.adjust(pvec, method = "BH")

results <- data.frame(
  Comparison = labs,
  Rho        = rho,
  N          = Ns,
  Raw_p      = pvec,
  FDR_p      = fdr_p,
  stringsAsFactors = FALSE
)

write.csv(results, "E:/liz/Defense/Neuroimaging/ants/ROI_Females_BH_results.csv", row.names = FALSE)
```

# Plot hippocampal subfields (only for visualization)
# triple plot
```{r}
library(ggplot2)
library(dplyr)
# install.packages("patchwork")  # run once
library(patchwork)

# ---- INPUTS ----
file_path <- "E:/liz/Defense/Neuroimaging/hippo_subfields_plot.csv"
df <- read.csv(file_path) |> na.omit()

make_panel <- function(df, x, y, title, col = "darkgreen") {
  keep <- complete.cases(df[[x]], df[[y]])
  ct   <- suppressWarnings(cor.test(df[[x]][keep], df[[y]][keep], method = "spearman"))
  rho  <- unname(ct$estimate); pval <- ct$p.value; N <- sum(keep)

  # label placement + spacing
  xr <- range(df[[x]][keep]); yr <- range(df[[y]][keep])
  x_left <- min(xr); y_top <- max(yr)
  step_y <- 0.10 * diff(yr)

  # plotmath labels: italic letters only, numbers upright
  p_str  <- if (pval < .001) "italic(p) < .001" else sprintf("italic(p) == %.3f", pval)

  ggplot(df, aes(x = .data[[x]], y = .data[[y]])) +
    geom_smooth(method = "lm", se = TRUE, color = col, fill = col, alpha = 0.4, linewidth = 1) +
    geom_point(color = col, size = 3, alpha = 0.7, shape = 19) +
    labs(title = title, x = expression("Volume (mm"^3*")"), y = "SOT (Angular Error)") +
    annotate("text", x = x_left, y = y_top,
             label = sprintf("italic(ρ) == %.2f", rho), parse = TRUE,
             hjust = 0, vjust = 1, size = 4) +
    annotate("text", x = x_left, y = y_top - step_y,
             label = p_str, parse = TRUE,
             hjust = 0, vjust = 1, size = 4) +
    annotate("text", x = x_left, y = y_top - 2*step_y,
             label = sprintf("'n ='~%d", N), parse = TRUE,
             hjust = 0, vjust = 1, size = 4) +
    theme_classic(base_size = 14) +
    theme(
      aspect.ratio = 1,
      panel.border = element_rect(colour = "black", fill = NA, linewidth = 0.7),
      plot.title   = element_text(size = 16, face = "bold", hjust = 0.5),
      plot.margin  = margin(2, 2, 2, 2)
    )
}

# ---- Build your three panels (edit x vars/titles as needed) ----
p1 <- make_panel(df, "LCA2.3", "winsorized_SOT", "Left CA2/3",  "#2E7D32")
p2 <- make_panel(df, "LSUB", "winsorized_SOT", "Left Subiculum", "#1565C0")  # <-- change to your column
p3 <- make_panel(df, "RSUB",   "winsorized_SOT", "Right Subiculum",    "#1565C0")  # <-- change to your column

# ---- Arrange close together ----
combo <- (p1 | p2 | p3) + plot_layout(nrow = 1, widths = c(1, 1, 1))

print(combo)
ggsave("hippo_tripanel.tiff", combo, width = 12, height = 4, dpi = 600, bg = "white")
```
